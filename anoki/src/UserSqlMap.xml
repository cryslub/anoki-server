<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="user">
	<insert id="insertUser" parameterClass="com.anoki.jaxb.User">

		INSERT INTO USER (ACCOUNT,PASS,COUNTRY,PHONE) VALUES
		(#account#,#pass#,#country#,#phone#)

		<selectKey keyProperty="id" resultClass="int">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<update id="updateUserDevice" parameterClass="com.anoki.jaxb.Phone">
		UPDATE USER SET DEVICE = #device#
		WHERE ID = #id#
	</update>

	<update id="updateUser" parameterClass="com.anoki.jaxb.User">
		UPDATE USER SET NAME = #name#
		,TEXT = #text#
		<isNotEmpty property="picture">		
		,PICTURE = #picture#
		</isNotEmpty>
		<isNotEmpty property="showPhone">
		,SHOW_PHONE = #showPhone#
		</isNotEmpty>
		<isNotEmpty property="pass">		
		,PASS = #pass#
		</isNotEmpty>
		<isNotEmpty property="phone">		
		,PHONE = #phone#
		</isNotEmpty>
		<isNotEmpty property="country">		
		,COUNTRY = #country#
		</isNotEmpty>

		WHERE ID = #id#
	</update>


	<update id="bindPhone" parameterClass="com.anoki.jaxb.User">
		UPDATE USER SET PHONE = '', COUNTRY=''
		WHERE ACCOUNT != #account#
		AND PHONE = #phone#
		AND COUNTRY = #country#
	</update>
	
	
	<select id="checkUser" parameterClass="com.anoki.jaxb.User" resultClass="int">
		SELECT ID FROM USER WHERE ACCOUNT=#account#
	</select>
	
	
	<select id="getIdWithPhone" parameterClass="com.anoki.jaxb.Phone" resultClass="int">
		SELECT ID FROM USER WHERE COUNTRY=#country# AND PHONE=#number#
	</select>
	
	<select id="getAccountWithPhone" parameterClass="com.anoki.jaxb.Phone" resultClass="string">
		SELECT ACCOUNT FROM USER WHERE COUNTRY=#country# AND PHONE=#number#
	</select>
	
	<select id="getUserId" parameterClass="com.anoki.jaxb.User" resultClass="int">
		SELECT ID FROM USER WHERE ACCOUNT=#account# AND PASS=#pass#
	</select>
	
	
	<select id="getUser" parameterClass="com.anoki.jaxb.User"
		resultClass="com.anoki.jaxb.User">
		SELECT 
			PICTURE,
			NAME,
			TEXT,
			ACCOUNT,
			SHOW_PHONE AS SHOWPHONE,
			COUNTRY,
			PHONE
		 FROM USER WHERE ID = #id#
	</select>
	
	
	<select id="userPrayer" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Prayer">
		SELECT
		USER.PICTURE AS USERPICTURE,
		USER.NAME AS USERNAME,
		PRAYER.TIME AS TIME,
		PRAYER.BACK AS BACK,
		PRAYER.TEXT AS TEXT,
		PRAYER.ID AS ID,
		PRAYER.USER AS USERID,
		(SELECT COUNT(*) FROM PRAY WHERE PRAYER = PRAYER.ID) AS PRAYCOUNT,
		(SELECT COUNT(*) FROM REPLY 
			WHERE PRAYER = PRAYER.ID
			AND (PUBLIC = 'Y' OR USER = #id# OR USER.ID = #id#) 
		) AS REPLYCOUNT,
		(SELECT MAX(TIME) FROM PRAY WHERE PRAYER = PRAYER.ID AND USER=#id#) AS LASTPRAYED,
		SCRAP.ID AS SCRAPD
		FROM PRAYER
		LEFT OUTER JOIN USER ON PRAYER.USER = USER.ID
		LEFT OUTER JOIN SCRAP ON PRAYER.ID = SCRAP.PRAYER AND SCRAP.USER=#id#
		WHERE
		PRAYER.USER = #searchId#
		AND PRAYER.TEAM = NULL
		<isEqual property="searchKey" compareValue="Y">
			AND PRAYER.COMPLETED = 'Y'
		</isEqual>
		ORDER
		BY PRAYER.TIME DESC
		LIMIT #page#,#size#
	</select>
	
	
	
	<select id="userTeam" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Team">
		SELECT 
			TEAM.PICTURE,
			TEAM.NAME,
			TEAM.ID
		FROM MEMBER
		LEFT OUTER JOIN TEAM ON MEMBER.TEAM = TEAM.ID
		WHERE MEMBER.USER = #id#
		AND MEMBER.STATE = 'J'
	</select>
	
</sqlMap>