<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="team">
	
	
	<select id="teamSearch" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Team">
		SELECT 
			TEAM.PICTURE,
			TEAM.NAME,
			TEAM.ID
		FROM TEAM
		WHERE TEAM.NAME LIKE CONCAT('%', #searchKey#, '%')
	</select>
	
	<select id="getTeam" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Team">
		SELECT 
			TEAM.PICTURE,
			TEAM.NAME,
			TEAM.TEXT,
			MEMBER.STATE,
			(SELECT group_concat(USER.NAME ', ') FROM MEMBER 
				LEFT OUTER JOIN USER ON USER.ID = MEMBER.USER
				WHERE MEMBER.TEAM = TEAM.ID
				AND (MEMBER.ROLE = 'L' OR MEMBER.ROLE = 'S') 
			) AS LEADER			
		FROM TEAM
		LEFT OUTER JOIN MEMBER ON TEAM.ID = MEMBER.TEAM AND MEMBER.USER = #id#  
		WHERE TEAM.ID = #searchId#
	</select>
	
	
	
	<select id="teamPrayer" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Prayer">
		SELECT
		USER.PICTURE AS USERPICTURE,
		USER.NAME AS USERNAME,
		PRAYER.TIME AS TIME,
		PRAYER.BACK AS BACK,
		PRAYER.TEXT AS TEXT,
		PRAYER.ID AS ID,
		PRAYER.USER AS USERID,
		(SELECT COUNT(*) FROM PRAY WHERE PRAYER = PRAYER.ID) AS PRAYCOUNT,
		(SELECT COUNT(*) FROM REPLY WHERE PRAYER = PRAYER.ID) AS REPLYCOUNT,
		(SELECT MAX(TIME) FROM PRAY WHERE PRAYER = PRAYER.ID AND USER=#id#) AS LASTPRAYED,
		SCRAP.ID AS SCRAPD
		FROM PRAYER
		LEFT OUTER JOIN USER ON PRAYER.USER = USER.ID
		LEFT OUTER JOIN SCRAP ON PRAYER.ID = SCRAP.PRAYER AND SCRAP.USER=#id#
		WHERE
		PRAYER.TEAM = #searchId#
		ORDER
		BY PRAYER.TIME DESC
		LIMIT #page#,#size#
	</select>
	
</sqlMap>