<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="prayer">

	<select id="recent" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Prayer">
		SELECT
		USER.PICTURE AS USERPICTURE,
		USER.NAME AS USERNAME,
		CONCAT(MONTH(PRAYER.TIME),'월 ',DAY(PRAYER.TIME),'일') AS TIME,
		PRAYER.BACK AS BACK,
		PRAYER.TEXT AS TEXT,
		PRAYER.ID AS ID,
		PRAYER.USER AS USERID,
		(SELECT COUNT(*) FROM PRAY WHERE PRAYER = PRAYER.ID) AS PRAYCOUNT,
		(SELECT COUNT(*) FROM REPLY 
			WHERE PRAYER = PRAYER.ID
			AND (PUBLIC = 'Y' OR USER = #id# OR USER.ID = #id#) 
		) AS REPLYCOUNT,
		(SELECT MAX(TIME) FROM PRAY WHERE PRAYER = PRAYER.ID AND USER=#id#) AS LASTPRAYED,
		SCRAP.ID AS SCRAPD
		FROM PRAYER
		LEFT OUTER JOIN USER ON PRAYER.USER = USER.ID
		LEFT OUTER JOIN SCRAP ON PRAYER.ID = SCRAP.PRAYER AND SCRAP.USER=#id#
		WHERE(
		PRAYER.USER = #id#
		OR PRAYER.PUBLIC = 'Y' AND PRAYER.USER IN (SELECT FRIEND FROM FRIEND
		WHERE USER = #id#))
		AND PRAYER.TEAM = -1
		ORDER
		BY PRAYER.TIME DESC
		LIMIT #page#,#size#
	</select>

	<select id="getPrayer" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Prayer">
		SELECT
		USER.PICTURE AS USERPICTURE,
		USER.NAME AS USERNAME,
		CONCAT(MONTH(PRAYER.TIME),'월 ',DAY(PRAYER.TIME),'일') AS TIME,
		PRAYER.BACK AS BACK,
		PRAYER.TEXT AS TEXT,
		PRAYER.ID AS ID,
		PRAYER.USER AS USERID,
		(SELECT COUNT(*) FROM PRAY WHERE PRAYER = PRAYER.ID) AS PRAYCOUNT,
		(SELECT COUNT(*) FROM REPLY 
			WHERE PRAYER = PRAYER.ID
			AND (PUBLIC = 'Y' OR USER = #id# OR USER.ID = #id#) 
		) AS REPLYCOUNT,		
		(SELECT COUNT(*) FROM REPLY WHERE PRAYER = PRAYER.ID AND TYPE='R') AS RESPONSECOUNT,		
		(SELECT MAX(TIME) FROM PRAY WHERE PRAYER = PRAYER.ID AND USER=#id#) AS LASTPRAYED,
		SCRAP.ID AS SCRAPD
		FROM PRAYER
		LEFT OUTER JOIN USER ON PRAYER.USER = USER.ID
		LEFT OUTER JOIN SCRAP ON PRAYER.ID = SCRAP.PRAYER AND SCRAP.USER=#id#
		WHERE
		PRAYER.ID = #searchId#
	</select>
	
	<select id="mediaList" parameterClass="com.anoki.jaxb.Search"
		resultClass="String">
		SELECT PATH FROM MEDIA
		WHERE PRAYER = #searchId#
	</select>

	
	<select id="replyList" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Reply">
		SELECT 
			USER.NAME,
			USER.PICTURE,
			REPLY.TEXT,
			REPLY.TIME,
			REPLY.TYPE,
			REPLY.PUBLIC AS PUB,
			USER.ID AS USERID
		FROM REPLY
		LEFT OUTER JOIN USER ON REPLY.USER = USER.ID
		LEFT OUTER JOIN PRAYER ON REPLY.PRAYER = PRAYER.ID
		WHERE REPLY.PRAYER = #searchId#
		AND (
			REPLY.PUBLIC = 'Y' 
			OR REPLY.USER = #id# 
			OR PRAYER.USER = #id#
		)	
	</select>


	<insert id="insertPrayer" parameterClass="com.anoki.jaxb.Prayer">
		INSERT INTO PRAYER (USER,BACK,TEXT,PUBLIC,TEAM) VALUES
		(#userId#,#back#,#text#,#pub#,#team#)
		
		<selectKey keyProperty="id" resultClass="int">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>


	<update id="updateMedia" parameterClass="com.anoki.jaxb.Prayer">
		UPDATE MEDIA SET PRAYER = #id#
		WHERE ID IN
		<iterate  property="media" open="(" conjunction="," close=")">
			#media[]#
		</iterate>
	</update>

	<insert id="insertRequest" parameterClass="com.anoki.jaxb.Prayer">
		INSERT INTO REQUEST (
			PRAYER,
			USER
		) VALUES 
		<iterate  conjunction=", " property="friends">(#id#, #friends[]#)</iterate>
	</insert>
	
	
	
	
	
	<insert id="insertMedia" parameterClass="com.anoki.jaxb.User">
		INSERT INTO MEDIA () VALUES ()
		
		<selectKey keyProperty="id" resultClass="int">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	
	
	
	<insert id="insertScrap" parameterClass="com.anoki.jaxb.Prayer">
		INSERT INTO SCRAP(
			USER,
			PRAYER
		)
		VALUES (#userId#,#id#)
	</insert>

	<insert id="insertPray" parameterClass="com.anoki.jaxb.Prayer">
		INSERT INTO PRAY(
			USER,
			PRAYER
		)
		VALUES (#userId#,#id#)
	</insert>
	
	
	
	<select id="scrapd" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Prayer">
		SELECT
		USER.PICTURE AS USERPICTURE,
		USER.NAME AS USERNAME,
		CONCAT(MONTH(PRAYER.TIME),'월 ',DAY(PRAYER.TIME),'일') AS TIME,
		PRAYER.BACK AS BACK,
		PRAYER.TEXT AS TEXT,
		PRAYER.ID AS ID,
		PRAYER.USER AS USERID,
		(SELECT COUNT(*) FROM PRAY WHERE PRAYER = PRAYER.ID) AS PRAYCOUNT,
		(SELECT COUNT(*) FROM REPLY WHERE PRAYER = PRAYER.ID
			AND (PUBLIC ='Y' OR USER = #id#)
		) AS REPLYCOUNT,
		(SELECT MAX(TIME) FROM PRAY WHERE PRAYER = PRAYER.ID AND USER=#id#) AS LASTPRAYED,
		SCRAP.ID AS SCRAPD
		FROM SCRAP
		LEFT OUTER JOIN PRAYER ON PRAYER.ID = SCRAP.PRAYER
		LEFT OUTER JOIN USER ON PRAYER.USER = USER.ID
		WHERE
		SCRAP.USER = #id#
		<isEqual property="searchKey" compareValue="Y">
			AND PRAYER.COMPLETED = 'Y'
		</isEqual>
		ORDER
		BY PRAYER.TIME DESC
		LIMIT #page#,#size#
	</select>
	
	
	
	<select id="request" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Prayer">
		SELECT
			USER.PICTURE AS USERPICTURE,
			USER.NAME AS USERNAME,
			CONCAT(MONTH(PRAYER.TIME),'월 ',DAY(PRAYER.TIME),'일') AS TIME,
			PRAYER.BACK AS BACK,
			PRAYER.TEXT AS TEXT,
			PRAYER.ID AS ID,
			PRAYER.USER AS USERID,
			(SELECT COUNT(*) FROM PRAY WHERE PRAYER = PRAYER.ID) AS PRAYCOUNT,
			(SELECT COUNT(*) FROM REPLY WHERE PRAYER = PRAYER.ID 
				AND (PUBLIC ='Y' OR USER = #id#)
			) AS REPLYCOUNT,
			(SELECT MAX(TIME) FROM PRAY WHERE PRAYER = PRAYER.ID AND USER=#id#) AS LASTPRAYED,
			SCRAP.ID AS SCRAPD
		FROM REQUEST
			LEFT OUTER JOIN PRAYER ON PRAYER.ID = REQUEST.PRAYER
			LEFT OUTER JOIN USER ON PRAYER.USER = USER.ID
			LEFT OUTER JOIN SCRAP ON PRAYER.ID = SCRAP.PRAYER AND REQUEST.USER=#id#
		WHERE
			REQUEST.USER = #id#
		ORDER BY PRAYER.TIME DESC
		LIMIT #page#,#size#
	</select>
	
	
	<insert id="insertReply" parameterClass="com.anoki.jaxb.Reply">
		INSERT INTO REPLY(
			PRAYER,
			USER,
			TEXT,
			PUBLIC,
			TYPE,
			PICTURE
		)
		VALUES (#prayer#,#userId#,#text#,#pub#,#type#,#picture#)
	</insert>
	
	<update id="complete" parameterClass="com.anoki.jaxb.Prayer">
		UPDATE PRAYER
		SET COMPLETED = 'Y'
		WHERE ID = #id#
	</update>
	
</sqlMap>

