<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="user">
	
	
	<select id="alarm" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Alarm">
		SELECT
			TYPE,
			NAME1,
			NAME2,			
			TIME,
			MEDIA
		FROM ALARM 
		WHERE USER = #id#
	</select>
	
	<delete id="deleteAlarm" parameterClass="com.anoki.jaxb.Search">
		DELETE FROM ALARM WHERE USER = #id#
	</delete>
	
	
	<select id="message" parameterClass="com.anoki.jaxb.Search"
		resultClass="com.anoki.jaxb.Message">
		SELECT
			MESSAGE.TEXT,
			USER.PICTURE,
			MESSAGE.TIME,			
			USER.NAME AS SENDER,
			MESSAGE.ID,
			MESSAGE.BACK
		FROM MESSAGE 
		LEFT OUTER JOIN USER ON MESSAGE.SENDER = USER.ID 
		WHERE MESSAGE.USER = #id#
		ORDER BY MESSAGE.TIME DESC
		LIMIT #page#,#size#
	</select>
	
	
	<insert id="insertMessage">
		INSERT INTO MESSAGE (
			USER,
			SENDER,
			TEXT,
			BACK
		) VALUES (#user#,#id#,#text#,#back#)
		
	</insert>
	
	
	<insert id="insertRequestAlarm" parameterClass="com.anoki.jaxb.Prayer">
		INSERT INTO ALARM (
			USER,
			TYPE,
			NAME1,
			MEDIA
		) VALUES 
		<iterate prepend="VALUES" conjunction=", " property="friends">
			<![CDATA[
			(#friends[]#, 
			'Q',
			SELECT NAME FROM USER WHERE ID = #userId#,
			SELECT PICTURE FRPOM USER WHERE ID = #userId#)
			]]>
		</iterate>
	</insert>
	
	
	<insert id="insertFriendAlarm" parameterClass="String">
		INSERT INTO ALARM (
			USER,
			TYPE,
			NAME1,
			MEDIA
		) VALUES 
		(SELECT USER FROM FRIEND WHERE ID = #id#, 
		'F',
		SELECT USER.NAME 
			FROM FRIEND LEFT OUTER JOIN USER ON FRIEND.FRIEND = USER.ID 
			WHERE FRIEND.ID = #id#,
		SELECT USER.PICTURE 
			FROM FRIEND LEFT OUTER JOIN USER ON FRIEND.FRIEND = USER.ID 
			WHERE FRIEND.ID = #id#)
	</insert>
	
	<select id="notice"
		resultClass="com.anoki.jaxb.Notice">
		SELECT
			*
		FROM NOTICE 
		ORDER BY TIME DESC
	</select>
	
	<select id="admin"
		resultClass="com.anoki.jaxb.Admin">
		SELECT
			*
		FROM ADMIN
		WHERE ACCOUNT = #id# AND PASS=#pass# 
	</select>
	
	<insert id="insertNotice" parameterClass="com.anoki.jaxb.Notice">
		INSERT INTO NOTICE (
			TEXT
		) VALUES (#text#)
		
	</insert>
	
	<update id="updateNotice" parameterClass="com.anoki.jaxb.Notice">
		UPDATE NOTICE SET TEXT = #text#
		WHERE ID = #id#
	</update>
	
	<delete id="deleteNotice" parameterClass="com.anoki.jaxb.Notice">
		DELETE FROM NOTICE WHERE ID = #id#
	</delete>


	<update id="updateAccount" parameterClass="com.anoki.jaxb.Admin">
		UPDATE ADMIN SET ACCOUNT = #id#
	</update>

	<update id="updatePass" parameterClass="com.anoki.jaxb.Admin">
		UPDATE ADMIN SET PASS = #pass#
	</update>
	
	
	
</sqlMap>